<html><head>
<title>app.py</title>
<meta name="Generator" content="htmlizer/[Twisted, version 18.9.0]" />
<link rel="alternate" href="app.py" type="text/x-python" />

</head>
<body>
<pre><span class="py-src-comment">#!/usr/bin/python3</span>
<span class="py-src-variable">from</span> <span class="py-src-variable">flask</span> <span class="py-src-variable">import</span> <span class="py-src-variable">Flask</span>, <span class="py-src-variable">render_template</span>, <span class="py-src-variable">request</span>, <span class="py-src-variable">redirect</span>, <span class="py-src-variable">url_for</span>
<span class="py-src-variable">from</span> <span class="py-src-variable">engine</span>.<span class="py-src-variable">db_manager</span> <span class="py-src-variable">import</span> <span class="py-src-variable">Database</span>
<span class="py-src-variable">from</span> <span class="py-src-variable">engine</span>.<span class="py-src-variable">user_manager</span> <span class="py-src-variable">import</span> <span class="py-src-variable">UserManager</span>
<span class="py-src-variable">from</span> <span class="py-src-variable">user</span> <span class="py-src-variable">import</span> <span class="py-src-variable">User</span>
<span class="py-src-variable">from</span> <span class="py-src-variable">datetime</span> <span class="py-src-variable">import</span> <span class="py-src-variable">datetime</span>, <span class="py-src-variable">timedelta</span>
<span class="py-src-variable">from</span> <span class="py-src-variable">customers</span> <span class="py-src-variable">import</span> <span class="py-src-variable">Customer</span>
<span class="py-src-variable">import</span> <span class="py-src-variable">os</span>
<span class="py-src-variable">from</span> <span class="py-src-variable">GPS</span> <span class="py-src-variable">import</span> <span class="py-src-variable">GPSTracker</span>

<span class="py-src-variable">app</span> = <span class="py-src-variable">Flask</span>(<span class="py-src-variable">__name__</span>)


<span class="py-src-comment"># Retrieve database credentials from environment variables</span>
<span class="py-src-variable">db_config</span> = {
    <span class="py-src-string">&#x27;host&#x27;</span>: <span class="py-src-string">&#x27;localhost&#x27;</span>,
    <span class="py-src-string">&#x27;user&#x27;</span>: <span class="py-src-string">&#x27;root&#x27;</span>,
    <span class="py-src-string">&#x27;password&#x27;</span>: <span class="py-src-string">&#x27;jobs123&#x27;</span>, 
    <span class="py-src-string">&#x27;database&#x27;</span>: <span class="py-src-string">&#x27;e_payment&#x27;</span> 
}

<span class="py-src-variable">db</span> = <span class="py-src-variable">Database</span>(<span class="py-src-variable">db_config</span>)
@<span class="py-src-variable">app</span>.<span class="py-src-variable">route</span>(<span class="py-src-string">&#x27;/insert_user&#x27;</span>, <span class="py-src-variable">methods</span>=[<span class="py-src-string">&#x27;POST&#x27;</span>, <span class="py-src-string">&#x27;GET&#x27;</span>])
<span class="py-src-variable">def</span> <span class="py-src-identifier">insert_user</span>():
    <span class="py-src-string">&quot;&quot;&quot;Insert User in the database.&quot;&quot;&quot;</span>
    <span class="py-src-variable">if</span> <span class="py-src-variable">request</span>.<span class="py-src-variable">method</span> == <span class="py-src-string">&#x27;POST&#x27;</span>:
        <span class="py-src-variable">first_name</span> = <span class="py-src-variable">request</span>.<span class="py-src-variable">form</span>[<span class="py-src-string">&#x27;first_name&#x27;</span>]
        <span class="py-src-variable">last_name</span> = <span class="py-src-variable">request</span>.<span class="py-src-variable">form</span>[<span class="py-src-string">&#x27;last_name&#x27;</span>]
        <span class="py-src-variable">email</span> = <span class="py-src-variable">request</span>.<span class="py-src-variable">form</span>[<span class="py-src-string">&#x27;email&#x27;</span>]
        <span class="py-src-variable">password</span> = <span class="py-src-variable">request</span>.<span class="py-src-variable">form</span>[<span class="py-src-string">&#x27;password&#x27;</span>]
        <span class="py-src-variable">username</span> = <span class="py-src-variable">request</span>.<span class="py-src-variable">form</span>[<span class="py-src-string">&#x27;username&#x27;</span>]
        <span class="py-src-variable">role</span> = <span class="py-src-variable">request</span>.<span class="py-src-variable">form</span>[<span class="py-src-string">&#x27;role&#x27;</span>]
        <span class="py-src-variable">phone</span> = <span class="py-src-variable">request</span>.<span class="py-src-variable">form</span>[<span class="py-src-string">&#x27;phone&#x27;</span>]

        <span class="py-src-variable">print</span>(<span class="py-src-string">f&#x27;phone:{phone}&#x27;</span>)
        <span class="py-src-variable">print</span>(<span class="py-src-string">f&#x27;role: {role}&#x27;</span>)
        <span class="py-src-variable">print</span>(<span class="py-src-variable">username</span>)
        <span class="py-src-variable">print</span>(<span class="py-src-variable">password</span>)
        <span class="py-src-variable">print</span>(<span class="py-src-variable">email</span>)
        <span class="py-src-variable">print</span>(<span class="py-src-variable">first_name</span>)
        <span class="py-src-variable">print</span>(<span class="py-src-variable">last_name</span>)

        <span class="py-src-variable">print</span>(<span class="py-src-variable">request</span>.<span class="py-src-variable">form</span>)

        <span class="py-src-variable">user</span> = <span class="py-src-variable">User</span>(<span class="py-src-variable">email</span>=<span class="py-src-variable">email</span>, <span class="py-src-variable">username</span>=<span class="py-src-variable">username</span>, <span class="py-src-variable">password</span>=<span class="py-src-variable">password</span>, <span class="py-src-variable">role</span>=<span class="py-src-variable">role</span>, <span class="py-src-variable">first_name</span>=<span class="py-src-variable">first_name</span>, <span class="py-src-variable">last_name</span>=<span class="py-src-variable">last_name</span>, <span class="py-src-variable">phone</span>=<span class="py-src-variable">phone</span>)
        <span class="py-src-variable">registration_result</span> = <span class="py-src-variable">db</span>.<span class="py-src-variable">insert_user</span>(<span class="py-src-variable">user</span>)
        <span class="py-src-variable">return</span> <span class="py-src-variable">render_template</span>(<span class="py-src-string">&#x27;registration_success.html&#x27;</span>)
    <span class="py-src-variable">else</span>:
        <span class="py-src-variable">return</span> <span class="py-src-variable">render_template</span>(<span class="py-src-string">&#x27;register.html&#x27;</span>)

@<span class="py-src-variable">app</span>.<span class="py-src-variable">route</span>(<span class="py-src-string">&#x27;/add_customer&#x27;</span>, <span class="py-src-variable">methods</span>=[<span class="py-src-string">&#x27;POST&#x27;</span>, <span class="py-src-string">&#x27;GET&#x27;</span>])
<span class="py-src-variable">def</span> <span class="py-src-identifier">add_customer</span>():
    <span class="py-src-variable">if</span> <span class="py-src-variable">request</span>.<span class="py-src-variable">method</span> == <span class="py-src-string">&#x27;POST&#x27;</span>:
        <span class="py-src-comment"># Check for the existence of required form fields</span>
        <span class="py-src-variable">if</span> <span class="py-src-variable">all</span>(<span class="py-src-variable">field</span> <span class="py-src-variable">in</span> <span class="py-src-variable">request</span>.<span class="py-src-variable">form</span> <span class="py-src-variable">for</span> <span class="py-src-variable">field</span> <span class="py-src-variable">in</span> [<span class="py-src-string">&#x27;first_name&#x27;</span>, <span class="py-src-string">&#x27;last_name&#x27;</span>, <span class="py-src-string">&#x27;email&#x27;</span>]):
            <span class="py-src-comment"># Access form data</span>
            <span class="py-src-variable">first_name</span> = <span class="py-src-variable">request</span>.<span class="py-src-variable">form</span>[<span class="py-src-string">&#x27;first_name&#x27;</span>]
            <span class="py-src-variable">last_name</span> = <span class="py-src-variable">request</span>.<span class="py-src-variable">form</span>[<span class="py-src-string">&#x27;last_name&#x27;</span>]
            <span class="py-src-variable">email</span> = <span class="py-src-variable">request</span>.<span class="py-src-variable">form</span>[<span class="py-src-string">&#x27;email&#x27;</span>]
            <span class="py-src-variable">create_date</span> = <span class="py-src-variable">datetime</span>.<span class="py-src-variable">now</span>()
            <span class="py-src-variable">last_update</span> = <span class="py-src-variable">datetime</span>.<span class="py-src-variable">now</span>()
            <span class="py-src-variable">active</span> = <span class="py-src-string">&#x27;active&#x27;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">request</span>.<span class="py-src-variable">form</span>

            <span class="py-src-comment"># Create a Customer object with the form data</span>
            <span class="py-src-variable">customer</span> = <span class="py-src-variable">Customer</span>(
                <span class="py-src-variable">first_name</span>=<span class="py-src-variable">first_name</span>,
                <span class="py-src-variable">last_name</span>=<span class="py-src-variable">last_name</span>,
                <span class="py-src-variable">email</span>=<span class="py-src-variable">email</span>,
                <span class="py-src-variable">active</span>=<span class="py-src-variable">active</span>,
            )

            <span class="py-src-comment"># Add the customer to the database</span>
            <span class="py-src-variable">registration_result</span> = <span class="py-src-variable">db</span>.<span class="py-src-variable">Add_customer</span>(<span class="py-src-variable">customer</span>)

            <span class="py-src-comment"># Redirect after successful form submission</span>
            <span class="py-src-variable">return</span> <span class="py-src-variable">render_template</span>(<span class="py-src-string">&#x27;success_template.html&#x27;</span>, <span class="py-src-variable">redirect_url</span>=<span class="py-src-variable">url_for</span>(<span class="py-src-string">&#x27;add_customer&#x27;</span>))
            <span class="py-src-comment">#return f&quot;The new customer has been saved&quot;</span>
        <span class="py-src-variable">else</span>:
            <span class="py-src-comment"># Handle the case when required form fields are missing</span>
            <span class="py-src-variable">flash</span>(<span class="py-src-string">&#x27;Please fill out all required fields.&#x27;</span>)
            <span class="py-src-variable">return</span> <span class="py-src-variable">redirect</span>(<span class="py-src-variable">url_for</span>(<span class="py-src-string">&#x27;add_customer&#x27;</span>))
    <span class="py-src-variable">else</span>:
        <span class="py-src-variable">return</span> <span class="py-src-variable">render_template</span>(<span class="py-src-string">&#x27;add_customer.html&#x27;</span>)

@<span class="py-src-variable">app</span>.<span class="py-src-variable">route</span>(<span class="py-src-string">&#x27;/&#x27;</span>)
<span class="py-src-variable">def</span> <span class="py-src-identifier">index</span>():
    <span class="py-src-variable">return</span> <span class="py-src-variable">render_template</span>(<span class="py-src-string">&#x27;login.jsp&#x27;</span>)

@<span class="py-src-variable">app</span>.<span class="py-src-variable">route</span>(<span class="py-src-string">&#x27;/login&#x27;</span>, <span class="py-src-variable">methods</span>=[<span class="py-src-string">&#x27;POST&#x27;</span>, <span class="py-src-string">&#x27;GET&#x27;</span>])
<span class="py-src-variable">def</span> <span class="py-src-identifier">login</span>():
    <span class="py-src-variable">username</span> = <span class="py-src-variable">request</span>.<span class="py-src-variable">form</span>[<span class="py-src-string">&#x27;username&#x27;</span>]
    <span class="py-src-variable">password</span> = <span class="py-src-variable">request</span>.<span class="py-src-variable">form</span>[<span class="py-src-string">&#x27;password&#x27;</span>]
    <span class="py-src-variable">user_manager</span> = <span class="py-src-variable">UserManager</span>(<span class="py-src-variable">db_config</span>)  <span class="py-src-comment"># Assuming UserManager is properly imported</span>

    <span class="py-src-variable">print</span>(<span class="py-src-variable">username</span>)
    <span class="py-src-variable">print</span>(<span class="py-src-variable">password</span>)

    <span class="py-src-variable">login_result</span>, <span class="py-src-variable">user_data</span> = <span class="py-src-variable">user_manager</span>.<span class="py-src-variable">login_user</span>(<span class="py-src-variable">username</span>, <span class="py-src-variable">password</span>)

    <span class="py-src-variable">if</span> <span class="py-src-variable">login_result</span>:
        <span class="py-src-comment"># Authentication successful, redirect to a new page or perform further actions</span>
        <span class="py-src-comment">#return f&quot;Welcome, {username}!&quot;</span>
        <span class="py-src-variable">return</span> <span class="py-src-variable">render_template</span>(<span class="py-src-string">&#x27;welcome.jsp&#x27;</span>, <span class="py-src-variable">user</span>=<span class="py-src-variable">username</span>, <span class="py-src-variable">role</span>=<span class="py-src-variable">user_data</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&#x27;role&#x27;</span>))
    <span class="py-src-variable">else</span>:
        <span class="py-src-comment"># Authentication failed, redirect back to the login page with a message</span>
        <span class="py-src-variable">return</span> <span class="py-src-variable">render_template</span>(<span class="py-src-string">&#x27;login.jsp&#x27;</span>, <span class="py-src-variable">message</span>=<span class="py-src-string">&#x27;Invalid credentials. Please try again.&#x27;</span>)
<span class="py-src-comment">#@app.route(&#x27;/welcome&#x27;, methods=[&#x27;POST&#x27;, &#x27;GET&#x27;])</span>

@<span class="py-src-variable">app</span>.<span class="py-src-variable">route</span>(<span class="py-src-string">&#x27;/welcome/&lt;username&gt;/&lt;role&gt;&#x27;</span>)
<span class="py-src-variable">def</span> <span class="py-src-identifier">welcome</span>(<span class="py-src-parameter">username</span>, <span class="py-src-parameter">right</span>):
    <span class="py-src-variable">return</span> <span class="py-src-variable">render_template</span>(<span class="py-src-string">&#x27;welcome.jsp&#x27;</span>, <span class="py-src-variable">user</span>=<span class="py-src-variable">username</span>, <span class="py-src-variable">role</span>=<span class="py-src-variable">role</span>)

@<span class="py-src-variable">app</span>.<span class="py-src-variable">route</span>(<span class="py-src-string">&#x27;/register_tracker&#x27;</span>, <span class="py-src-variable">methods</span>=[<span class="py-src-string">&#x27;GET&#x27;</span>, <span class="py-src-string">&#x27;POST&#x27;</span>])
<span class="py-src-variable">def</span> <span class="py-src-identifier">register_tracker</span>():
    <span class="py-src-variable">if</span> <span class="py-src-variable">request</span>.<span class="py-src-variable">method</span> == <span class="py-src-string">&#x27;POST&#x27;</span>:
        <span class="py-src-variable">EMEI</span> = <span class="py-src-variable">request</span>.<span class="py-src-variable">form</span>[<span class="py-src-string">&#x27;EMEI&#x27;</span>]
        <span class="py-src-variable">Model_Name</span> = <span class="py-src-variable">request</span>.<span class="py-src-variable">form</span>[<span class="py-src-string">&#x27;Model_Name&#x27;</span>]
        <span class="py-src-variable">Activated_date</span> = <span class="py-src-variable">datetime</span>.<span class="py-src-variable">strptime</span>(<span class="py-src-variable">request</span>.<span class="py-src-variable">form</span>[<span class="py-src-string">&#x27;Activated_date&#x27;</span>], <span class="py-src-string">&#x27;%Y-%m-%d&#x27;</span>)
        <span class="py-src-variable">GPS_Experied_date</span> = <span class="py-src-variable">datetime</span>.<span class="py-src-variable">strptime</span>(<span class="py-src-variable">request</span>.<span class="py-src-variable">form</span>[<span class="py-src-string">&#x27;GPS_Experied_date&#x27;</span>], <span class="py-src-string">&#x27;%Y-%m-%d&#x27;</span>)

        <span class="py-src-variable">new_tracker</span> = <span class="py-src-variable">GPSTracker</span>(
            <span class="py-src-variable">EMEI</span>=<span class="py-src-variable">EMEI</span>,
            <span class="py-src-variable">Model_Name</span>=<span class="py-src-variable">Model_Name</span>,
            <span class="py-src-variable">Activated_date</span>=<span class="py-src-variable">Activated_date</span>,
            <span class="py-src-variable">GPS_Experied_date</span>=<span class="py-src-variable">GPS_Experied_date</span>
        )
        <span class="py-src-variable">registration_result</span> = <span class="py-src-variable">db</span>.<span class="py-src-variable">Add_GPS</span>(<span class="py-src-variable">new_tracker</span>)
        <span class="py-src-variable">return</span> <span class="py-src-variable">redirect</span>(<span class="py-src-variable">url_for</span>(<span class="py-src-string">&#x27;tracker_registered&#x27;</span>, <span class="py-src-variable">EMEI</span>=<span class="py-src-variable">int</span>(<span class="py-src-variable">EMEI</span>)))

    <span class="py-src-variable">return</span> <span class="py-src-variable">render_template</span>(<span class="py-src-string">&#x27;register_tracker.html&#x27;</span>)

@<span class="py-src-variable">app</span>.<span class="py-src-variable">route</span>(<span class="py-src-string">&#x27;/tracker_registered/&lt;int:EMEI&gt;&#x27;</span>)
<span class="py-src-variable">def</span> <span class="py-src-identifier">tracker_registered</span>(<span class="py-src-parameter">EMEI</span>):
    <span class="py-src-variable">query</span> = <span class="py-src-string">&#x27;SELECT * FROM gps WHERE EMEI = %s&#x27;</span>
    <span class="py-src-variable">tracker</span> = <span class="py-src-variable">db</span>.<span class="py-src-variable">fetch_one</span>(<span class="py-src-variable">query</span>, (<span class="py-src-variable">EMEI</span>,))
    <span class="py-src-variable">print</span>(<span class="py-src-variable">tracker</span>)
    <span class="py-src-variable">return</span> <span class="py-src-variable">render_template</span>(<span class="py-src-string">&#x27;tracker_registered.html&#x27;</span>, <span class="py-src-variable">tracker</span>=<span class="py-src-variable">tracker</span>)

@<span class="py-src-variable">app</span>.<span class="py-src-variable">route</span>(<span class="py-src-string">&#x27;/search_emei&#x27;</span>, <span class="py-src-variable">methods</span>=[<span class="py-src-string">&#x27;GET&#x27;</span>, <span class="py-src-string">&#x27;POST&#x27;</span>])
<span class="py-src-variable">def</span> <span class="py-src-identifier">search_emei</span>():
    <span class="py-src-string">&quot;&quot;&quot;Search for the emei based on user input.&quot;&quot;&quot;</span>
    <span class="py-src-variable">if</span> <span class="py-src-variable">request</span>.<span class="py-src-variable">method</span> == <span class="py-src-string">&#x27;POST&#x27;</span>:
        <span class="py-src-variable">EMEI</span> = <span class="py-src-variable">request</span>.<span class="py-src-variable">form</span>[<span class="py-src-string">&#x27;EMEI&#x27;</span>]
        <span class="py-src-variable">query</span> = <span class="py-src-string">&#x27;SELECT * FROM gps WHERE EMEI = %s&#x27;</span>
        <span class="py-src-variable">tracker</span> = <span class="py-src-variable">db</span>.<span class="py-src-variable">fetch_one</span>(<span class="py-src-variable">query</span>, (<span class="py-src-variable">EMEI</span>,))
        <span class="py-src-variable">print</span>(<span class="py-src-variable">tracker</span>)
        <span class="py-src-variable">return</span> <span class="py-src-string">f&#x27;EMEI: {tracker[0]} Model: {tracker[1]} Created at: {tracker[2]}, \nsee you next time.&#x27;</span>
    <span class="py-src-variable">return</span> <span class="py-src-variable">render_template</span>(<span class="py-src-string">&#x27;search_emei.html&#x27;</span>)



<span class="py-src-variable">if</span> <span class="py-src-variable">__name__</span> == <span class="py-src-string">&#x27;__main__&#x27;</span>:
    <span class="py-src-variable">app</span>.<span class="py-src-variable">run</span>( <span class="py-src-variable">host</span>=<span class="py-src-string">&#x27;0.0.0.0&#x27;</span>, <span class="py-src-variable">port</span>=<span class="py-src-string">&#x27;4500&#x27;</span>, <span class="py-src-variable">debug</span>=<span class="py-src-variable">True</span>)
</pre>
</body>
